<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>deployer.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../../marionetta.html">marionetta.rb</a>
          <a class="source" href="../command_runner.html">command_runner.rb</a>
          <a class="source" href="../group.html">group.rb</a>
          <a class="source" href="../manipulators.html">manipulators.rb</a>
          <a class="source" href="debloyer.html">debloyer.rb</a>
          <a class="source" href="deployer.html">deployer.rb</a>
          <a class="source" href="puppet_manipulator.html">puppet_manipulator.rb</a>
          <a class="source" href="../rake_helper.html">rake_helper.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>deployer.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><code>Deployer</code> is a class for rsyncing your application to a
remote machine.</p>

<p>Using a directory structure similar to capistrano <code>Deployer</code>
maintains a folder of releases so you may rollback quickly.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;marionetta/command_runner&#39;</span>

<span class="k">module</span> <span class="nn">Marionetta</span>
  <span class="k">module</span> <span class="nn">Manipulators</span>
    <span class="k">class</span> <span class="nc">Deployer</span></pre></div>
      </td>
    </tr>
    <tr id='section-RakeHelper_tasks'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-RakeHelper_tasks">&#182;</a>
        </div>
        <h2>RakeHelper tasks</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p><code>Deployer</code> provides two rake tasks when used with
<code>RakeHelper</code> namely <code>:deploy</code> and <code>:rollback</code>. When
applied through <code>RakeHelper</code> they will appear
namespaced under <code>:deployer</code> and your group name.</p>

<p>With a group name of <code>:staging</code> would appear as:</p>

<pre><code>deployer:staging:deploy
deployer:staging:rollback
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">tasks</span><span class="p">()</span>
        <span class="o">[</span><span class="ss">:deploy</span><span class="p">,</span> <span class="ss">:rollback</span><span class="o">]</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Server_hash_requirements'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Server_hash_requirements">&#182;</a>
        </div>
        <h2>Server hash requirements</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>The keys <code>[:deployer][:from]</code> and <code>[:deployer][:to]</code>
must be set in your <code>server</code> hash in order for
<code>Deployer</code> to work.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="vi">@server</span> <span class="o">=</span> <span class="n">server</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Call <code>.can?()</code> to check if the correct keys have be
passed in as the server.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">can?</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">]</span>
        
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:from</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:to</span><span class="p">)</span>
          <span class="k">return</span> <span class="kp">true</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="kp">false</span>
        <span class="k">end</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Deploying'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Deploying">&#182;</a>
        </div>
        <h2>Deploying</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Call <code>.deploy()</code> to run a deploy to your remote
server. The process involves:</p>

<ul>
<li><code>:from</code> directory copied to temporary directory</li>
<li><code>:exclude</code> files are removed</li>
<li>rsync&rsquo;d to a releases directory</li>
<li><code>:before_script</code> run</li>
<li>release directory symlinked to a current directory</li>
<li><code>:after_script</code> run</li>
</ul>

<p>The directory structure under <code>server[:deployer][:to]</code>
looks something like this:</p>

<p>current/ &ndash;&gt; ./releases/2012-09-20<em>14:04:39
  releases/
    2012-09-20</em>13:59:15
    2012-09-20_14:04:39</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">deploy</span><span class="p">()</span>
        <span class="n">release</span> <span class="o">=</span> <span class="n">timestamp</span>

        <span class="n">send_files</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>

        <span class="n">run_script</span><span class="p">(</span><span class="ss">:before</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span>
        <span class="n">symlink_release_dir</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="n">run_script</span><span class="p">(</span><span class="ss">:after</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>To get an array of all releases call <code>.releases()</code>.
Any release that is subsequently rolled back will not
be listed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">releases</span><span class="p">()</span>
        <span class="n">releases</span> <span class="o">=</span> <span class="o">[]</span>

        <span class="n">cmd</span><span class="o">.</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;ls -m </span><span class="si">#{</span><span class="n">releases_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">stdout</span><span class="o">|</span>
          <span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/[,\s]+/</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">release</span><span class="o">|</span>
            <span class="n">releases</span> <span class="o">&lt;&lt;</span> <span class="n">release</span> <span class="k">unless</span> <span class="n">release</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;skip-&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="k">return</span> <span class="n">releases</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>If you push out and need to rollback to the previous
version you can use <code>.rollback()</code> to do just that.
Currently you can only rollback once at a time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">rollback</span><span class="p">()</span>
        <span class="n">rollback_to_release</span> <span class="o">=</span> <span class="n">releases</span><span class="o">[-</span><span class="mi">2</span><span class="o">]</span>

        <span class="k">if</span> <span class="n">rollback_to_release</span><span class="o">.</span><span class="n">nil?</span>
          <span class="n">server</span><span class="o">[</span><span class="ss">:logger</span><span class="o">].</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No release to rollback to&#39;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">current_release_dir</span> <span class="o">=</span> <span class="n">release_dir</span><span class="p">(</span><span class="n">releases</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
          <span class="n">skip_current_release_dir</span> <span class="o">=</span> <span class="n">release_dir</span><span class="p">(</span><span class="s2">&quot;skip-</span><span class="si">#{</span><span class="n">releases</span><span class="o">.</span><span class="n">last</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="n">cmd</span><span class="o">.</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">current_release_dir</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">skip_current_release_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="n">symlink_release_dir</span><span class="p">(</span><span class="n">rollback_to_release</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-Dependency_Injection'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Dependency_Injection">&#182;</a>
        </div>
        <h2>Dependency Injection</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>To use your own alternative to <code>CommandRunner</code> you can
set an object of your choice via the <code>.cmd=</code> method.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kp">attr_writer</span> <span class="ss">:cmd</span>

    <span class="kp">private</span>
      
      <span class="kp">attr_reader</span> <span class="ss">:server</span>

      <span class="k">def</span> <span class="nf">cmd</span><span class="p">()</span>
        <span class="vi">@cmd</span> <span class="o">||=</span> <span class="no">CommandRunner</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">from_dir</span><span class="p">()</span>
        <span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">][</span><span class="ss">:from</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">to_dir</span><span class="p">()</span>
        <span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">][</span><span class="ss">:to</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">releases_dir</span><span class="p">()</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">to_dir</span><span class="si">}</span><span class="s2">/releases&quot;</span>
      <span class="k">end</span>
      
      <span class="k">def</span> <span class="nf">release_dir</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">releases_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">release</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">current_dir</span><span class="p">()</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="n">to_dir</span><span class="si">}</span><span class="s2">/current&quot;</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">fatal</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">server</span><span class="o">[</span><span class="ss">:logger</span><span class="o">].</span><span class="n">fatal</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">last</span><span class="p">)</span>
        <span class="n">server</span><span class="o">[</span><span class="ss">:logger</span><span class="o">].</span><span class="n">fatal</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">rsync_exclude_flags</span><span class="p">(</span><span class="n">exclude_files</span><span class="p">)</span>
        <span class="n">exclude_files</span> <span class="o">=</span> <span class="n">exclude_files</span><span class="o">.</span><span class="n">clone</span>
        <span class="n">exclude_files</span><span class="o">.</span><span class="n">map!</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">from_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">}</span>
        <span class="n">exclude_files</span><span class="o">.</span><span class="n">flatten!</span>
        <span class="n">exclude_files</span><span class="o">.</span><span class="n">map!</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">from_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
        <span class="n">exclude_files</span><span class="o">.</span><span class="n">map!</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">[</span><span class="s1">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">]</span><span class="p">}</span>
        <span class="n">exclude_files</span><span class="o">.</span><span class="n">flatten!</span>
        <span class="k">return</span> <span class="n">exclude_files</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">send_files</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="n">release_dir</span> <span class="o">=</span> <span class="n">release_dir</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">release_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="o">[</span><span class="no">Dir</span><span class="o">[</span><span class="n">from_dir</span><span class="o">+</span><span class="s1">&#39;/*&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">release_dir</span><span class="o">]</span>

        <span class="k">if</span> <span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">].</span><span class="n">has_key?</span><span class="p">(</span><span class="ss">:exclude</span><span class="p">)</span>
          <span class="n">args</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rsync_exclude_flags</span><span class="p">(</span><span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">][</span><span class="ss">:exclude</span><span class="o">]</span><span class="p">))</span>
        <span class="k">end</span>

        <span class="k">unless</span> <span class="n">cmd</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
          <span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;Could not rsync release&#39;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">release</span><span class="p">)</span>
        <span class="n">script_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">script</span><span class="si">}</span><span class="s2">_script&quot;</span><span class="o">.</span><span class="n">to_sym</span>

        <span class="k">if</span> <span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">].</span><span class="n">has_key?</span><span class="p">(</span><span class="n">script_key</span><span class="p">)</span>
          <span class="n">script</span> <span class="o">=</span> <span class="n">server</span><span class="o">[</span><span class="ss">:deployer</span><span class="o">][</span><span class="n">script_key</span><span class="o">]</span>
          <span class="n">cmd</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="s1">&#39;/tmp&#39;</span><span class="p">)</span>
          <span class="n">tmp_script</span> <span class="o">=</span> <span class="s2">&quot;/tmp/</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">script</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="n">cmd</span><span class="o">.</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;chmod +x </span><span class="si">#{</span><span class="n">tmp_script</span><span class="si">}</span><span class="s2"> &amp;&amp; exec </span><span class="si">#{</span><span class="n">tmp_script</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">release</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">symlink_release_dir</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="n">release_dir</span> <span class="o">=</span> <span class="n">release_dir</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>

        <span class="k">unless</span> <span class="n">cmd</span><span class="o">.</span><span class="n">ssh</span><span class="p">(</span><span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2"> &amp;&amp; ln -s </span><span class="si">#{</span><span class="n">release_dir</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;Could not symlink release as current&#39;</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">timestamp</span><span class="p">()</span>
        <span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%F_%T&#39;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
